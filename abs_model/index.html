<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Highcharts Example</title>

    <link rel="stylesheet" href="static/jquery-ui-1.12.1.css">
    <script type="text/javascript" src="static/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="static/jquery-ui-1.12.1.js"></script>

    <script type="text/javascript" src="static/highcharts.js"></script>
    <script type="text/javascript" src="static/modules/exporting.js"></script>


  </head>

	<body>
    <div id="tabs">
      <ul>
      </ul>
    </div>
  </body>

  <script type="text/javascript">



/**
 * In order to synchronize tooltips and crosshairs, override the
 * built-in events with handlers defined on the parent element.
 */
function my_override(container_id) {
	$(container_id).bind('mousemove touchmove touchstart', function (e) {
		  var chart,
		      point,
		      i,
		      event;

		  for (i = 0; i < Highcharts.charts.length; i = i + 1) {
		      chart = Highcharts.charts[i];
		      event = chart.pointer.normalize(e.originalEvent); // Find coordinates within the chart
		      point = chart.series[0].searchPoint(event, true); // Get the hovered point

		      if (point) {
		          point.highlight(e);
		      }
		  }
	});
}

/**
 * Override the reset function, we don't need to hide the tooltips and crosshairs.
 */
Highcharts.Pointer.prototype.reset = function () {
    return undefined;
};

/**
 * Highlight a point by showing tooltip, setting hover state and draw crosshair
 */
Highcharts.Point.prototype.highlight = function (event) {
    this.onMouseOver(); // Show the hover marker
    this.series.chart.tooltip.refresh(this); // Show the tooltip
    this.series.chart.xAxis[0].drawCrosshair(event, this); // Show the crosshair
};

/**
 * Synchronize zooming through the setExtremes event handler.
 */
function syncExtremes(e) {
    var thisChart = this.chart;

    if (e.trigger !== 'syncExtremes') { // Prevent feedback loop
        Highcharts.each(Highcharts.charts, function (chart) {
            if (chart !== thisChart) {
                if (chart.xAxis[0].setExtremes) { // It is null while updating
                    chart.xAxis[0].setExtremes(e.min, e.max, undefined, false, { trigger: 'syncExtremes' });
                }
            }
        });
    }
}




function to_highchart_date(startdate, offset) {
    return startdate + (offset * 60 * 1000);
}

function build_component_plot(container_id,name,latencies,instances) {
    if (latencies.length > 0) {
        new_container_id = 'c' + container_id;
        $(container_id).append('<h3> Latency vs VMs </h3>');
        $(container_id).append('<div id="' + new_container_id + '" style="min-width: 310px; min-height: 400px; height: 400px; margin: 0 auto"></div>');

        var series = [];
				series.push({
						name: 'Latency',
						type: 'line',
						turboThreshold: 0,
						tooltip: { valueSuffix: ' ms'},
				    data: latencies.map( function(item,index) {
				                         return {
				                             x: to_highchart_date(0, index),
				                             y: item
				                             //name: 'aa'//item.trdT
				                         };
				                     }).filter( function(item) {
																				  return item.y > 0;
														 						})
				});
				series.push({
						name: 'Instances',
						type: 'line',
						turboThreshold: 0,
						yAxis: 1,
				    data: instances.map( function(item,index) {
				                         return {
				                             x: to_highchart_date(0, index),
				                             y: item
				                         };
				                     })});
				Highcharts.chart(new_container_id, {
				    chart: {
				        zoomType: 'xy'
				    },
				    title: {
				        text: name
				    },
				    xAxis: [{
				        type: 'datetime',
				        dateTimeLabelFormats: {
				            month: '%e. %b',
				            year: '%b'
				        },
				        title: {
				            text: 'Time'
				        }
				    }],
				    yAxis: [
							{
				        title: {
				            text: 'Latency',
										style: {
						          color: Highcharts.getOptions().colors[0]
						      	}
				        },
				        min: 0,
								labels: {
						      format: '{value} ms',
						      style: {
						          color: Highcharts.getOptions().colors[0]
						      }
				        }
					    },
							{
				        title: {
				            text: 'Instances',
										style: {
						          color: Highcharts.getOptions().colors[1]
						      	}
				        },
				        min: 0,
								opposite: true,
								labels: {
									format: '{value}',
						      style: {
						          color: Highcharts.getOptions().colors[1]
						      }
				        }
					    }
						],
				    tooltip: {
				        xDateFormat: '%Y-%m-%d',
				        headerFormat: '<b>{series.name}</b><br>',
				        pointFormat: '<b>{point.y:.2f}t</b> {point.name} at {point.x:%H:%m}'
				    },
				    plotOptions: {
				        line: {
				            marker: {
				                enabled: false
				            }
				        }
				    },
						legend: {
								layout: 'vertical',
								align: 'left',
								x: 120,
								verticalAlign: 'top',
								y: 100,
								floating: true,
								backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
						},
				    series: series
				});

    }
}

function build_request_plot(container_id,name,requests,pending) {
    if (requests.length > 0) {
        new_container_id = 'creq' + container_id;
        $(container_id).append('<h3> Requests arrived vs Pending </h3>');
        $(container_id).append('<div id="' + new_container_id + '" style="min-width: 310px; min-height: 400px; height: 400px; margin: 0 auto"></div>');

        var series = [];
				series.push({
						name: 'Requests arrived',
						type: 'line',
						turboThreshold: 0,
						data: requests.map( function(item,index) {
				                         return {
				                             x: to_highchart_date(0, index),
				                             y: item
				                             //name: 'aa'//item.trdT
				                         };
				                     })
				});
				series.push({
						name: 'Pending requests',
						type: 'line',
						turboThreshold: 0,
						data: pending.map( function(item,index) {
				                         return {
				                             x: to_highchart_date(0, index),
				                             y: item
				                         };
				                     })});
				Highcharts.chart(new_container_id, {
				    chart: {
				        zoomType: 'xy'
				    },
				    title: {
				        text: name
				    },
				    xAxis: [{
				        
								type: 'datetime',
				        dateTimeLabelFormats: {
				            month: '%e. %b',
				            year: '%b'
				        },
				        title: {
				            text: 'Time'
				        }
				    }],
				    yAxis: [
							{
				        title: {
				            text: '# of requests',
				        },
				        min: 0
					    }
						],
				    tooltip: {
				        xDateFormat: '%Y-%m-%d',
				        headerFormat: '<b>{series.name}</b><br>',
				        pointFormat: '<b>{point.y:.2f}t</b> {point.name} at {point.x:%H:%m}'
				    },
				    plotOptions: {
				        line: {
				            marker: {
				                enabled: false
				            }
				        }
				    },
						legend: {
								layout: 'vertical',
								align: 'left',
								x: 120,
								verticalAlign: 'top',
								y: 100,
								floating: true,
								backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
						},
				    series: series
				});
    }
}


function add_sync_plot(container_id,name,y_axis,data_list,unit_of_measure) {
		var series = [];
		series.push({
				name: name,
				type: 'line',
				turboThreshold: 0,
				tooltip: { valueSuffix: ' ' + unit_of_measure },
				data: data_list.map( function(item,index) {
		                         return {
		                             x: to_highchart_date(0, index),
		                             y: item
		                         };
		                     }).filter( function(item) {
																				  return item.y >= 0;
														 						})
		});

		var new_container_id = container_id + '_sync_plot_' + name;
		$("#" + container_id).append('<div id="' + new_container_id + '" style="min-width: 310px; min-height: 300px; height: 300px; margin: 0 auto"></div>');
		
		Highcharts.chart(new_container_id, {
            chart: {
                marginLeft: 60, // Keep all charts left aligned
                spacingTop: 40,
                spacingBottom: 20,
								zoomType: 'x'
            },
            title: {
                text: name,
                align: 'left',
                margin: 0,
                x: 30
            },
            credits: {
                enabled: false
            },
            legend: {
                enabled: false
            },
				    xAxis: {
				        type: 'datetime',
				        dateTimeLabelFormats: {
				            month: '%e. %b',
				            year: '%b'
				        },
				        title: {
				            text: 'Time'
				        },
                crosshair: true,
                events: {
                    setExtremes: syncExtremes
                }
				    },
            yAxis: {
                title: {
                    text: y_axis
                }
            },
            tooltip: {
                positioner: function () {
                    return {
                        x: this.chart.chartWidth - this.label.width, // right aligned
                        y: 10 // align to title
                    };
                },
                borderWidth: 0,
                backgroundColor: 'none',
                pointFormat: '{point.y}',
                headerFormat: '',
                shadow: false,
                style: {
                    fontSize: '18px'
                },
                valueDecimals: 0
            },
            series: series
        });
		my_override('#'+new_container_id);

}


function printInConsole(obj, str = ""){
		var output = str;
		for (property in obj) {
    		output += property + ': ' + obj[property]+'; ';
		}
		console.log(output);
}

function sort_tabs(tabs){
	tabs.tabs("refresh");
	var ul = tabs.find("ul");
	var tab_items = ul.children("li");
	tab_items.sort( function(a,b) {
		  var textA = $(a).text();
		  var textB = $(b).text();
			//console.log( textA);
			if (textA < textB) return -1;
		  if (textA > textB) return 1;

		  return 0;
		});
	ul.append(tab_items);
	tabs.tabs( { 'active': 0} );
}

function loadJSON(){
		// get the data for all the components
		$.getJSON("/o")
				.done(function(comp_list) {
						comp_list.forEach( function(item) {
								$.getJSON("/call/" + item + "/get_history").done( function(result) {
										var tabs = $("#tabs").tabs();
										var ul = tabs.find("ul");
										$('<li><a href="#' + item + '">' + result['result']['name'] + '</a></li>').appendTo(ul);
										tabs.append('<div id="' + item + '"> </div>');
										sort_tabs(tabs);
									
//										build_component_plot('#'+item, result['name'], result['result']['latencies'],result['result']['instances']);
//										build_request_plot('#'+item, result['name'], result['result']['requests'],result['result']['pending'])

										add_sync_plot(item, "Latency", "", result['result']['latencies'], "ms");
										add_sync_plot(item, "Instances", "", result['result']['instances'], "");
										add_sync_plot(item, "Requests", "", result['result']['requests'], "");
										add_sync_plot(item, "Pending", "", result['result']['pending'], "");
										
										
										//printInConsole(data,"step "); 
								});
						});
				});
}



/*
    $.getJSON("/o/Component1/measure_list")
			.done(function(data) {
		      var history = data['measure_list'];	
					build_component_plot('comp1',history);
		  })
			.fail(function() {
					$('#per-component').append('<p> JSON Query Error </p>');
			}); */

$(document).ready(function(){
		loadJSON();
		//tabs.tabs( { 'active': 0} )
});
  </script>



</html>
